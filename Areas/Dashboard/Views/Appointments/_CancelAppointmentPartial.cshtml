@model E_Commerce.Areas.Dashboard.Models.Appointment

<div class="modal-header bg-danger text-white">
    <h5 class="modal-title"><i class="fas fa-times-circle"></i> Cancel Appointment</h5>
    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
</div>

<div class="modal-body">
    <div class="alert alert-warning">
        <i class="fas fa-exclamation-triangle"></i>
        <strong>Warning:</strong> This action cannot be undone. The appointment will be permanently removed from the system.
    </div>

    <div class="card mb-3">
        <div class="card-body">
            <h6 class="card-title">Appointment Details</h6>
            <p><strong>Customer:</strong> @Model.Customer?.Name</p>
            <p><strong>Technician:</strong> @(Model.Employee != null ? $"{Model.Employee.FirstName} {Model.Employee.LastName}" : "Not Assigned")</p>
            <p><strong>Date & Time:</strong> @Model.StartTime.ToString("f")</p>
            <p><strong>Issue:</strong> @Model.IssueType</p>
            <p><strong>Status:</strong> <span class="badge bg-secondary">@Model.Status</span></p>
        </div>
    </div>

    <form id="cancelAppointmentForm"
          asp-action="CancelAppointment"
          asp-controller="Appointments"
          asp-area="Dashboard"
          method="post">
        @Html.AntiForgeryToken()
        <input type="hidden" name="id" value="@Model.Id" />

        <div class="mb-3">
            <label for="cancellationReason" class="form-label">Cancellation Reason (Optional)</label>
            <textarea class="form-control" id="cancellationReason" name="cancellationReason" rows="3"
                      placeholder="Enter reason for cancellation..."></textarea>
        </div>
    </form>
</div>

<div class="modal-footer">
    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
        <i class="fas fa-arrow-left"></i> Keep Appointment
    </button>
    <button type="button" class="btn btn-danger" onclick="submitCancelForm()">
        <i class="fas fa-times-circle"></i> Confirm Cancellation
    </button>
</div>

<script>
    function submitCancelForm() {
        if (confirm('Are you sure you want to permanently cancel this appointment? This action cannot be undone.')) {
            const form = document.getElementById('cancelAppointmentForm');
            const btn = event.target;
            const originalText = btn.innerHTML;

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cancelling...';

            const formData = new FormData(form);

            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('✅ ' + data.message);
                    // Close modal and reload
                    const modal = bootstrap.Modal.getInstance(document.getElementById('ajaxModal'));
                    if (modal) modal.hide();
                    setTimeout(() => location.reload(), 1000);
                } else {
                    alert('❌ ' + data.error);
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('❌ An error occurred while cancelling the appointment.');
                btn.disabled = false;
                btn.innerHTML = originalText;
            });
        }
    }
</script>