@using E_Commerce.Areas.Dashboard.Controllers
@using System.Security.Claims
@{
    ViewData["Title"] = "Dashboard";
    Layout = "~/Areas/Dashboard/Views/Shared/_Layout.cshtml";

    // Get the current user's email and role
    var userEmail = User.FindFirstValue(ClaimTypes.Email) ?? "";
    var userRole = ViewBag.UserRole as string ?? "Employee";
    var isAdmin = userRole == "Administrator";
}

<main>
<br />
<br />
    <div class="container-fluid px-4">
        <!-- Welcome Header - ONLY SHOW FOR NON-ADMIN ROLES -->
        @if (!isAdmin)
        {
            <div class="row">
                <div class="col-12">
                    <div class="card mb-4 border-0 shadow-sm">
                        <div class="card-header bg-modern-primary text-white">
                            <h2 class="mb-0"><i class="fas fa-tachometer-alt me-2"></i>@userRole Dashboard</h2>
                        </div>
                        <div class="card-body">
                            <h3>Welcome, @ViewBag.UserName!</h3>
                            <p class="lead">You are logged in as: <strong class="text-modern-primary">@userRole</strong></p>

                            <!-- Role-specific welcome message -->
                            <div class="alert alert-info alert-permanent border-0" style="background: linear-gradient(45deg, #e3f2fd, #bbdefb);">
                                <h5><i class="fas fa-info-circle me-2 text-modern-primary"></i>Your Access Level</h5>
                                <p class="mb-0">
                                    @if (userRole == "Technician")
                                    {
                                        <text>As a <strong>Technician</strong>, you can view and manage maintenance appointments, customer service requests, and update appointment statuses.</text>
                                    }
                                    else if (userRole == "Sales Representative")
                                    {
                                        <text>As a <strong>Sales Representative</strong>, you can manage products, categories, view order information, and handle customer inquiries.</text>
                                    }
                                    else if (userRole == "Customer Manager")
                                    {
                                        <text>As a <strong>Customer Manager</strong>, you can manage customer information, view order history, and handle customer relationships.</text>
                                    }
                                    else
                                    {
                                        <text>You have limited access to the system. Contact an administrator for additional permissions.</text>
                                    }
                                </p>
                                <small class="text-muted mt-2 d-block">
                                    <i class="fas fa-exclamation-triangle me-1"></i>
                                    If you believe your access level is incorrect, please contact the system administrator.
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }

        <!-- ADMIN DASHBOARD (Full reporting with graphs) -->
        @if (isAdmin)
        {
            <!-- Summary Cards - START IMMEDIATELY FOR ADMIN -->
            <div class="row">
                <div class="col-xl-3 col-md-6">
                    <div class="card bg-modern-primary text-white mb-4 border-0 shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <div class="fs-4">@(ViewBag.TotalCustomers ?? 0)</div>
                                    <div>Total Customers</div>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-users fa-2x opacity-75"></i>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer d-flex align-items-center justify-content-between bg-dark bg-opacity-25 border-0">
                            <a class="small text-white stretched-link" asp-area="Dashboard" asp-controller="Customer" asp-action="Index">View Details</a>
                            <div class="small text-white"><i class="fas fa-angle-right"></i></div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-3 col-md-6">
                    <div class="card bg-modern-secondary text-white mb-4 border-0 shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <div class="fs-4">@(ViewBag.TotalEmployees ?? 0)</div>
                                    <div>Employees</div>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-id-badge fa-2x opacity-75"></i>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer d-flex align-items-center justify-content-between bg-dark bg-opacity-25 border-0">
                            <a class="small text-white stretched-link" asp-area="Dashboard" asp-controller="Employee" asp-action="Index">View Details</a>
                            <div class="small text-white"><i class="fas fa-angle-right"></i></div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-3 col-md-6">
                    <div class="card bg-modern-accent text-white mb-4 border-0 shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <div class="fs-4">@(ViewBag.TotalProducts ?? 0)</div>
                                    <div>Total Products</div>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-shopping-bag fa-2x opacity-75"></i>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer d-flex align-items-center justify-content-between bg-dark bg-opacity-25 border-0">
                            <a class="small text-white stretched-link" asp-area="Dashboard" asp-controller="Products" asp-action="Index">View Details</a>
                            <div class="small text-white"><i class="fas fa-angle-right"></i></div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-3 col-md-6">
                    <div class="card bg-modern-success text-white mb-4 border-0 shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <div class="fs-4">@(ViewBag.PendingAppointments ?? 0)</div>
                                    <div>Pending Appointments</div>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-calendar-check fa-2x opacity-75"></i>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer d-flex align-items-center justify-content-between bg-dark bg-opacity-25 border-0">
                            <a class="small text-white stretched-link" asp-area="Dashboard" asp-controller="Appointments" asp-action="Index">View Details</a>
                            <div class="small text-white"><i class="fas fa-angle-right"></i></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analytics & Insights Section -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-header bg-white border-0">
                            <i class="fas fa-chart-line me-1 text-modern-primary"></i>
                            Analytics & Insights
                        </div>
                        <div class="card-body">
                            <div class="row g-4">
                                <!-- Customer Distribution by City -->
                                <div class="col-xl-6 col-lg-12">
                                    <div class="card h-100 border-0 shadow-sm">
                                        <div class="card-header bg-white border-bottom">
                                            <h6 class="mb-0 text-modern-primary">
                                                <i class="fas fa-map-marker-alt me-2"></i>
                                                Customer Distribution by City
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <canvas id="customerLocationChart" height="250"></canvas>
                                        </div>
                                    </div>
                                </div>

                                <!-- Appointment Trends -->
                                <div class="col-xl-6 col-lg-12">
                                    <div class="card h-100 border-0 shadow-sm">
                                        <div class="card-header bg-white border-bottom">
                                            <h6 class="mb-0 text-modern-success">
                                                <i class="fas fa-calendar-alt me-2"></i>
                                                Appointment Trends (Last 6 Months)
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <canvas id="appointmentTrendsChart" height="250"></canvas>
                                        </div>
                                    </div>
                                </div>

                                <!-- Service Type Analysis -->
                                <div class="col-xl-6 col-lg-12">
                                    <div class="card h-100 border-0 shadow-sm">
                                        <div class="card-header bg-white border-bottom">
                                            <h6 class="mb-0 text-modern-accent">
                                                <i class="fas fa-tools me-2"></i>
                                                Service Type Analysis
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <canvas id="serviceTypeChart" height="250"></canvas>
                                        </div>
                                    </div>
                                </div>

                                <!-- Revenue Insights -->
                                <div class="col-xl-6 col-lg-12">
                                    <div class="card h-100 border-0 shadow-sm">
                                        <div class="card-header bg-white border-bottom">
                                            <h6 class="mb-0 text-modern-secondary">
                                                <i class="fas fa-dollar-sign me-2"></i>
                                                Revenue Insights
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="row text-center mb-3">
                                                <div class="col-4">
                                                    <div class="border-end">
                                                        @{
                                                            var revenueInsights = ViewBag.RevenueInsights as E_Commerce.Areas.Dashboard.Controllers.RevenueInsightsViewModel;
                                                            var totalRevenue = revenueInsights?.TotalRevenue ?? 0;
                                                            var avgMonthly = revenueInsights?.AverageMonthly ?? 0;
                                                            var growthRate = revenueInsights?.GrowthRate ?? 0;
                                                        }
                                                        <div class="h4 text-modern-success" id="totalRevenue">R @totalRevenue.ToString("N0")</div>
                                                        <small class="text-muted">Total Revenue</small>
                                                    </div>
                                                </div>
                                                <div class="col-4">
                                                    <div class="border-end">
                                                        <div class="h4 text-modern-primary" id="avgMonthlyRevenue">R @avgMonthly.ToString("N0")</div>
                                                        <small class="text-muted">Monthly Avg</small>
                                                    </div>
                                                </div>
                                                <div class="col-4">
                                                    <div class="@(growthRate >= 0 ? "text-modern-success" : "text-danger")">
                                                        <div class="h4" id="growthRate">
                                                            @if (growthRate >= 0)
                                                            {
                                                                <i class="fas fa-arrow-up me-1"></i>
                                                            }
                                                            else
                                                            {
                                                                <i class="fas fa-arrow-down me-1"></i>
                                                            }
                                                            @($"{Math.Abs(growthRate):F1}%")
                                                        </div>
                                                        <small class="text-muted">Growth Rate</small>
                                                    </div>
                                                </div>
                                            </div>
                                            <canvas id="revenueChart" height="150"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="row">
                <div class="col-xl-6">
                    <div class="card mb-4 border-0 shadow-sm">
                        <div class="card-header bg-white border-0">
                            <i class="fas fa-table me-1 text-modern-primary"></i>
                            Recent Appointments
                            <span class="badge bg-modern-primary ms-2" id="appointmentsCount">
                                @((ViewBag.RecentAppointments as List<RecentAppointmentViewModel>)?.Count ?? 0)
                            </span>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Customer</th>
                                            <th>Technician</th>
                                            <th>Date</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @if (ViewBag.RecentAppointments != null && (ViewBag.RecentAppointments as List<RecentAppointmentViewModel>).Count > 0)
                                        {
                                            foreach (var appointment in ViewBag.RecentAppointments as List<RecentAppointmentViewModel>)
                                            {
                                                <tr>
                                                    <td>@appointment.CustomerName</td>
                                                    <td>@appointment.TechnicianName</td>
                                                    <td>@appointment.StartTime.ToString("MMM dd, yyyy")</td>
                                                    <td>
                                                        <span class="badge bg-@appointment.StatusColor">
                                                            @appointment.Status
                                                        </span>
                                                    </td>
                                                </tr>
                                            }
                                        }
                                        else
                                        {
                                            <tr>
                                                <td colspan="4" class="text-center text-muted py-3">
                                                    <i class="fas fa-calendar-times fa-2x mb-2"></i>
                                                    <br>
                                                    No recent appointments found
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-6">
                    <div class="card mb-4 border-0 shadow-sm">
                        <div class="card-header bg-white border-0">
                            <i class="fas fa-clipboard-list me-1 text-modern-secondary"></i>
                            Recent System Activity
                            <span class="badge bg-modern-secondary ms-2" id="logsCount">
                                @((ViewBag.RecentLogs as List<RecentLogViewModel>)?.Count ?? 0)
                            </span>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Action</th>
                                            <th>User</th>
                                            <th>Time</th>
                                            <th>Description</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @if (ViewBag.RecentLogs != null && (ViewBag.RecentLogs as List<RecentLogViewModel>).Count > 0)
                                        {
                                            foreach (var log in ViewBag.RecentLogs as List<RecentLogViewModel>)
                                            {
                                                <tr>
                                                    <td>
                                                        <span class="badge bg-@log.ActionColor">
                                                            @log.Action
                                                        </span>
                                                    </td>
                                                    <td>@log.UserEmail</td>
                                                    <td>@log.Timestamp.ToString("MMM dd HH:mm")</td>
                                                    <td class="text-truncate" style="max-width: 200px;" title="@log.Description">
                                                        @log.Description
                                                    </td>
                                                </tr>
                                            }
                                        }
                                        else
                                        {
                                            <tr>
                                                <td colspan="4" class="text-center text-muted py-3">
                                                    <i class="fas fa-clipboard-list fa-2x mb-2"></i>
                                                    <br>
                                                    No recent activity found
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="row">
                <div class="col-12">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white border-0">
                            <i class="fas fa-bolt me-1 text-modern-accent"></i>
                            Quick Actions
                        </div>
                        <div class="card-body p-3">
                            <div class="row g-2">
                                <div class="col-md-3 col-6">
                                    <a class="nav-link text-center p-3 border rounded quick-action-btn" asp-area="Dashboard" asp-controller="Appointments" asp-action="Index">
                                        <i class="fas fa-calendar-plus fa-2x mb-2 text-modern-primary"></i>
                                        <div class="fw-semibold">New Appointment</div>
                                    </a>
                                </div>
                                <div class="col-md-3 col-6">
                                    <a class="nav-link text-center p-3 border rounded quick-action-btn" asp-area="Dashboard" asp-controller="Customer" asp-action="Index">
                                        <i class="fas fa-user-plus fa-2x mb-2 text-modern-success"></i>
                                        <div class="fw-semibold">Add Customer</div>
                                    </a>
                                </div>
                                <div class="col-md-3 col-6">
                                    <a class="nav-link text-center p-3 border rounded quick-action-btn" asp-area="Dashboard" asp-controller="Product" asp-action="Index">
                                        <i class="fas fa-shopping-bag fa-2x mb-2 text-modern-accent"></i>
                                        <div class="fw-semibold">Add Product</div>
                                    </a>
                                </div>
                                <div class="col-md-3 col-6">
                                    <a class="nav-link text-center p-3 border rounded quick-action-btn" asp-area="Dashboard" asp-controller="Employee" asp-action="Index">
                                        <i class="fas fa-id-card fa-2x mb-2 text-modern-secondary"></i>
                                        <div class="fw-semibold">Add Employee</div>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
        else if (userRole == "Technician")
        {
            <!-- TECHNICIAN DASHBOARD -->
            <div class="row">
                <!-- Quick Stats -->
                <div class="col-xl-4 col-md-6">
                    <div class="card bg-modern-primary text-white mb-4 border-0 shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <div class="fs-4">@(ViewBag.TodaysAppointments ?? 0)</div>
                                    <div>Today's Appointments</div>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-calendar-day fa-2x opacity-75"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-4 col-md-6">
                    <div class="card bg-modern-success text-white mb-4 border-0 shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <div class="fs-4">@(ViewBag.RecentCompleted ?? 0)</div>
                                    <div>Completed This Week</div>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-check-circle fa-2x opacity-75"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-4 col-md-6">
                    <div class="card bg-modern-accent text-white mb-4 border-0 shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <div class="fs-4">@(ViewBag.PendingAppointments ?? 0)</div>
                                    <div>Pending Appointments</div>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-clock fa-2x opacity-75"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Upcoming Appointments -->
            <div class="row">
                <div class="col-12">
                    <div class="card mb-4 border-0 shadow-sm">
                        <div class="card-header bg-white border-0">
                            <i class="fas fa-clock me-1 text-modern-primary"></i>
                            Upcoming Appointments
                        </div>
                        <div class="card-body">
                            @if (ViewBag.UpcomingAppointments != null && ViewBag.UpcomingAppointments.Count > 0)
                            {
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>Customer</th>
                                                <th>Date & Time</th>
                                                <th>Service Type</th>
                                                <th>Status</th>
                                                
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var appointment in ViewBag.UpcomingAppointments)
                                            {
                                                <tr>
                                                    <td>@appointment.Customer?.Name</td>
                                                    <td>@appointment.StartTime.ToString("MMM dd, yyyy HH:mm")</td>
                                                    <td>@appointment.IssueType</td>
                                                    <td><span class="badge bg-warning">@appointment.Status</span></td>
                                                    
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            }
                            else
                            {
                                <p class="text-muted">No upcoming appointments scheduled.</p>
                            }
                        </div>
                    </div>
                </div>
            </div>
        }
        else if (userRole == "Sales Representative")
        {
            <!-- SALES DASHBOARD -->
            <div class="row">
                <div class="col-xl-3 col-md-6">
                    <div class="card bg-modern-primary text-white mb-4 border-0 shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <div class="fs-4">@(ViewBag.TotalProducts ?? 0)</div>
                                    <div>Total Products</div>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-boxes fa-2x opacity-75"></i>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer d-flex align-items-center justify-content-between bg-dark bg-opacity-25 border-0">
                            <a class="small text-white stretched-link" asp-area="Dashboard" asp-controller="Products" asp-action="Index">View Products</a>
                            <div class="small text-white"><i class="fas fa-angle-right"></i></div>
                        </div>
                    </div>
                </div>
               
                <div class="col-xl-3 col-md-6">
                    <div class="card bg-modern-accent text-white mb-4 border-0 shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <div class="fs-4">@(ViewBag.TotalCategories ?? 0)</div>
                                    <div>Categories</div>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-tags fa-2x opacity-75"></i>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer d-flex align-items-center justify-content-between bg-dark bg-opacity-25 border-0">
                            <a class="small text-white stretched-link" asp-area="Dashboard" asp-controller="Categories" asp-action="Index">View Categories</a>
                            <div class="small text-white"><i class="fas fa-angle-right"></i></div>
                        </div>
                    </div>
                </div>
                
            </div>

            <!-- Recent Orders -->
            <div class="row">
                <div class="col-12">
                    <div class="card mb-4 border-0 shadow-sm">
                        <div class="card-header bg-white border-0">
                            <i class="fas fa-shopping-cart me-1 text-modern-primary"></i>
                            Recent Orders
                        </div>
                        <div class="card-body">
                            @if (ViewBag.RecentOrders != null && ViewBag.RecentOrders.Count > 0)
                            {
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>Order #</th>
                                                <th>Customer</th>
                                                <th>Date</th>
                                                <th>Total</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var order in ViewBag.RecentOrders)
                                            {
                                                <tr>
                                                    <td>#@order.Id</td>
                                                    <td>@order.CustomerName</td>
                                                    <td>@order.OrderDate.ToString("MMM dd, yyyy")</td>
                                                    <td>R @order.Total.ToString("N2")</td>
                                                    <td><span class="badge bg-info">@order.Status</span></td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            }
                            else
                            {
                                <p class="text-muted">No recent orders found.</p>
                            }
                        </div>
                    </div>
                </div>
            </div>
        }
        else if (userRole == "Customer Manager")
        {
            <!-- CUSTOMER MANAGER DASHBOARD -->
            <div class="row">
                <div class="col-xl-3 col-md-6">
                    <div class="card bg-modern-primary text-white mb-4 border-0 shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <div class="fs-4">@(ViewBag.TotalCustomers ?? 0)</div>
                                    <div>Total Customers</div>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-users fa-2x opacity-75"></i>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer d-flex align-items-center justify-content-between bg-dark bg-opacity-25 border-0">
                            <a class="small text-white stretched-link" asp-area="Dashboard" asp-controller="Customer" asp-action="Index">Manage Customers</a>
                            <div class="small text-white"><i class="fas fa-angle-right"></i></div>
                        </div>
                    </div>
                </div>
               
            </div>

            <!-- Recent Customers -->
            <div class="row">
                <div class="col-12">
                    <div class="card mb-4 border-0 shadow-sm">
                        <div class="card-header bg-white border-0">
                            <i class="fas fa-users me-1 text-modern-primary"></i>
                            Recent Customers
                        </div>
                        <div class="card-body">
                            @if (ViewBag.RecentCustomers != null && ViewBag.RecentCustomers.Count > 0)
                            {
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>Name</th>
                                                <th>Email</th>
                                                <th>Phone</th>
                                                <th>City</th>
                                               
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var customer in ViewBag.RecentCustomers)
                                            {
                                                <tr>
                                                    <td>@customer.Name</td>
                                                    <td>@customer.Email</td>
                                                    <td>@customer.ContactNumber</td>
                                                    <td>@customer.City</td>
                                                    
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            }
                            else
                            {
                                <p class="text-muted">No customers found.</p>
                            }
                        </div>
                    </div>
                </div>
            </div>
        }
        else
        {
            <!-- EMPLOYEE/GENERAL DASHBOARD -->
            <div class="row">
                <div class="col-12">
                    <div class="card mb-4 border-0 shadow-sm">
                        <div class="card-body text-center py-5">
                            <i class="fas fa-user-tie fa-4x text-modern-primary mb-3"></i>
                            <h4 class="text-modern-primary">Employee Dashboard</h4>
                            <p class="text-muted">Welcome to your dashboard. You have limited access to the system.</p>
                            <p class="text-muted">Contact an administrator if you need additional permissions.</p>

                            @if (ViewBag.RecentActivity != null && ViewBag.RecentActivity.Count > 0)
                            {
                                <div class="mt-4">
                                    <h5>Recent System Activity</h5>
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Time</th>
                                                    <th>Action</th>
                                                    <th>Description</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @foreach (var activity in ViewBag.RecentActivity)
                                                {
                                                    <tr>
                                                        <td>@activity.Timestamp.ToString("MMM dd HH:mm")</td>
                                                        <td><span class="badge bg-secondary">@activity.Action</span></td>
                                                        <td>@activity.Description</td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        }

        <!-- Quick Actions for All Roles -->
        <div class="row">
            <div class="col-12">
                <div class="card mb-4 border-0 shadow-sm">
                    <div class="card-header bg-white border-0">
                        <i class="fas fa-rocket me-1 text-modern-accent"></i>
                        Quick Actions
                    </div>
                    <div class="card-body">
                        <div class="row">
                            @if (isAdmin || userRole == "Customer Manager" || userRole == "Technician" || userRole == "Sales Representative")
                            {
                                <div class="col-md-3 mb-2">
                                    <a class="btn btn-outline-modern-primary w-100" asp-area="Dashboard" asp-controller="Customer" asp-action="Index">
                                        <i class="fas fa-users me-2"></i>Manage Customers
                                    </a>
                                </div>
                            }
                            @if (isAdmin || userRole == "Sales Representative")
                            {
                                <div class="col-md-3 mb-2">
                                    <a class="btn btn-outline-modern-success w-100" asp-area="Dashboard" asp-controller="Products" asp-action="Index">
                                        <i class="fas fa-boxes me-2"></i>Manage Products
                                    </a>
                                </div>
                            }
                            @if (userRole == "Sales Representative")
                            {
                                <div class="col-md-3 mb-2">
                                    <a class="btn btn-outline-modern-success w-100" asp-area="Dashboard" asp-controller="Categories" asp-action="Index">
                                        <i class="fas fa-boxes me-2"></i>Manage Categories
                                    </a>
                                </div>
                            }
                            @if (isAdmin || userRole == "Technician")
                            {
                                <div class="col-md-3 mb-2">
                                    <a class="btn btn-outline-modern-accent w-100" asp-area="Dashboard" asp-controller="Appointments" asp-action="Index">
                                        <i class="fas fa-tools me-2"></i>View Appointments
                                    </a>
                                </div>
                            }
                            @if (isAdmin || userRole == "Sales Representative" || userRole == "Customer Manager")
                            {
                                <div class="col-md-3 mb-2">
                                    <a class="btn btn-outline-modern-secondary w-100" asp-area="Dashboard" asp-controller="Orders" asp-action="Index">
                                        <i class="fas fa-shopping-cart me-2"></i>View Orders
                                    </a>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- AJAX Modal -->
<div class="modal fade" id="ajaxModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content" id="ajaxModalContent"></div>
    </div>
</div>



<style>
    /* Modern Color Scheme */
    .bg-modern-primary {
        background: linear-gradient(45deg, #667eea, #764ba2) !important;
    }

    .bg-modern-secondary {
        background: linear-gradient(45deg, #f093fb, #f5576c) !important;
    }

    .bg-modern-accent {
        background: linear-gradient(45deg, #4facfe, #00f2fe) !important;
    }

    .bg-modern-success {
        background: linear-gradient(45deg, #43e97b, #38f9d7) !important;
    }

    .text-modern-primary {
        color: #667eea !important;
    }

    .text-modern-secondary {
        color: #f5576c !important;
    }

    .text-modern-accent {
        color: #4facfe !important;
    }

    .text-modern-success {
        color: #43e97b !important;
    }

    .btn-outline-modern-primary {
        color: #667eea;
        border-color: #667eea;
    }

        .btn-outline-modern-primary:hover {
            background-color: #667eea;
            color: white;
        }

    .btn-outline-modern-success {
        color: #43e97b;
        border-color: #43e97b;
    }

        .btn-outline-modern-success:hover {
            background-color: #43e97b;
            color: white;
        }

    .btn-outline-modern-accent {
        color: #4facfe;
        border-color: #4facfe;
    }

        .btn-outline-modern-accent:hover {
            background-color: #4facfe;
            color: white;
        }

    .btn-outline-modern-secondary {
        color: #f5576c;
        border-color: #f5576c;
    }

        .btn-outline-modern-secondary:hover {
            background-color: #f5576c;
            color: white;
        }

    .card {
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        border: none;
    }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.15) !important;
        }

    .table th {
        border-top: none;
        font-weight: 600;
        font-size: 0.875rem;
        color: #6c757d;
        background-color: #f8f9fa;
    }

    .quick-action-btn {
        font-size: 0.875rem;
        transition: all 0.3s ease-in-out;
        border: 2px solid transparent !important;
    }

        .quick-action-btn:hover {
            transform: translateY(-3px);
            border-color: #e9ecef !important;
            background-color: #f8f9fa !important;
        }
</style>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Update badge counts for admin
            const appointmentsCount = @((ViewBag.RecentAppointments as List<RecentAppointmentViewModel>)?.Count ?? 0);
            const logsCount = @((ViewBag.RecentLogs as List<RecentLogViewModel>)?.Count ?? 0);

            if (document.getElementById('appointmentsCount')) {
                document.getElementById('appointmentsCount').textContent = appointmentsCount;
            }
            if (document.getElementById('logsCount')) {
                document.getElementById('logsCount').textContent = logsCount;
            }

            // Initialize charts only for Admin dashboard
            @if (isAdmin)
            {
                    <text>initializeAdminCharts();</text>
            }
        });

        function initializeAdminCharts() {
            // Modern color palette
            const modernColors = {
                primary: ['#667eea', '#764ba2'],
                secondary: ['#f093fb', '#f5576c'],
                accent: ['#4facfe', '#00f2fe'],
                success: ['#43e97b', '#38f9d7']
            };

            // Customer Location Chart
            const locationCtx = document.getElementById('customerLocationChart');
            if (locationCtx) {
                const locationData = @Html.Raw(Json.Serialize(ViewBag.CustomerLocationData));

                new Chart(locationCtx, {
                    type: 'bar',
                    data: {
                        labels: locationData ? locationData.map(x => x.city) : [],
                        datasets: [{
                            label: 'Customers',
                            data: locationData ? locationData.map(x => x.count) : [],
                            backgroundColor: modernColors.primary[0],
                            borderColor: modernColors.primary[1],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: false },
                            title: {
                                display: true,
                                text: 'Customer Distribution by City'
                            }
                        },
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            }

            // Appointment Trends Chart
            const trendsCtx = document.getElementById('appointmentTrendsChart');
            if (trendsCtx) {
                const trendsData = @Html.Raw(Json.Serialize(ViewBag.AppointmentTrends));

                new Chart(trendsCtx, {
                    type: 'line',
                    data: {
                        labels: trendsData ? trendsData.map(x => x.period) : [],
                        datasets: [
                            {
                                label: 'Total Appointments',
                                data: trendsData ? trendsData.map(x => x.totalAppointments) : [],
                                borderColor: modernColors.primary[0],
                                backgroundColor: modernColors.primary[0] + '20',
                                tension: 0.4,
                                fill: true
                            },
                            {
                                label: 'Completed',
                                data: trendsData ? trendsData.map(x => x.completed) : [],
                                borderColor: modernColors.success[0],
                                backgroundColor: modernColors.success[0] + '20',
                                tension: 0.4,
                                fill: true
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Appointment Trends (Last 6 Months)'
                            }
                        }
                    }
                });
            }

            // Service Type Chart
            const serviceCtx = document.getElementById('serviceTypeChart');
            if (serviceCtx) {
                const serviceData = @Html.Raw(Json.Serialize(ViewBag.ServiceTypeAnalysis));

                new Chart(serviceCtx, {
                    type: 'doughnut',
                    data: {
                        labels: serviceData ? serviceData.map(x => x.serviceType) : [],
                        datasets: [{
                            data: serviceData ? serviceData.map(x => x.count) : [],
                            backgroundColor: [
                                modernColors.primary[0],
                                modernColors.secondary[0],
                                modernColors.accent[0],
                                modernColors.success[0],
                                modernColors.primary[1],
                                modernColors.secondary[1],
                                modernColors.accent[1],
                                modernColors.success[1]
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Service Type Distribution'
                            }
                        }
                    }
                });
            }

            // Revenue Chart
            const revenueCtx = document.getElementById('revenueChart');
            if (revenueCtx) {
                const revenueData = @Html.Raw(Json.Serialize(ViewBag.RevenueInsights?.MonthlyData));

                new Chart(revenueCtx, {
                    type: 'bar',
                    data: {
                        labels: revenueData ? revenueData.map(x => x.period) : [],
                        datasets: [{
                            label: 'Monthly Revenue (ZAR)',
                            data: revenueData ? revenueData.map(x => x.revenue) : [],
                            backgroundColor: modernColors.accent[0],
                            borderColor: modernColors.accent[1],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return 'R' + value.toLocaleString('en-ZA');
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }
    </script>
}